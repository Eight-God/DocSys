<!DOCTYPE html>
<html style="height: 100%;">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>TextEditor</title>
    <script src="static/scripts/jquery.min.js"></script>
    <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/bootstrapQ/qiao.css" rel="stylesheet">
    <script type="text/javascript" src="static/bootstrapQ/qiao.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script type="text/javascript" src="js/base64.js"></script>
    <script type="text/javascript" src="js/DocSys.js"></script>

    <!-- editormd -->
	<link href="static/markdown/css/editormd.min.css" rel="stylesheet">
	<link href="static/markdown/css/add.css" rel="stylesheet">
	<script src="static/markdown/editormd.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/link-dialog/link-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/reference-link-dialog/reference-link-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/image-dialog/image-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/code-block-dialog/code-block-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/table-dialog/table-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/emoji-dialog/emoji-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/goto-line-dialog/goto-line-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/help-dialog/help-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/html-entities-dialog/html-entities-dialog.js" type="text/javascript"></script>
    <script src="static/markdown/plugins/preformatted-text-dialog/preformatted-text-dialog.js" type="text/javascript"></script>
	<script src="static/markdown/lib/raphael.min.js" type="application/javascript"></script>
	
	<script type="text/javascript" src="js/CommonEditor.js"></script>
    
    <style type="text/css" media="screen">
	  body {
	      overflow: hidden;
	  }
	
	  #editor {
	      margin: 40px 0 0 0;
	      position: absolute;
	      top: 0;
	      bottom: 0;
	      left: 0;
	      right: 0;
	  }
	  
	  .editormd-preview{
            left: 0 !important;
            right: auto !important;
      }

      .editormd .CodeMirror {
            float: right !important;
      }	  
	</style>
</head>
<body style="height: 100%; margin: 0;">
	<div id="mdViewer">
		<!-- <div id="mdViewerToolBar" style="height:100px;">
		     <button id="btnMdExitEdit" class="btn btn-default" type="button" onclick="EditormdEditor.exitEdit()" style="display:none">退出编辑
		     </button>
		     <button id="btnMdSaveWiki" class="btn btn-default" type="button" onclick="EditormdEditor.saveWiki()" style="display:none">保存
		     </button>
		</div>
		-->
		<div class="EditormdEditorContent" style="min-height: 600px;">
			<div id="mdPlayer">
			</div>
		</div>
	</div>
	<script type="text/javascript">
		var EditormdEditor = (function () {
			var commonEditor; //It will be set when callback from commonEditor
			var editor;		  //editormd	
			
			//抽象编辑器的以下接口, 通过config参数传递给CommonEditor
			//"initEditor": initEditorForEditormd,
			//"setContent": setContentForEditormd,
			//"getContent": setContentForEditormd,
			//"setEditMode": setEditModeForEditormd,			
			//"onLoadDocument": onLoadDocumentForEditormd,
			
			var initEditor = function()
			{
	        	commonEditor = this;
		  		console.log("initEditorForEditormd editState:" + commonEditor.editState);
		  		
		  		var params = {
		           width: "100%",
		           height: $(document).height()-70,
		           path : 'static/markdown/lib/',
		           markdown : "",	//markdown的内容默认务必是空，否则会出现当文件内容是空的时候显示默认内容
		           toolbar  : false,             // 关闭工具栏
		           codeFold : true,
		           searchReplace : true,
		           saveHTMLToTextarea : true,      // 保存 HTML 到 Textarea
		           htmlDecode : "style,script,iframe|on*",            // 开启 HTML 标签解析，为了安全性，默认不开启
		           emoji : true,
		           taskList : true,
		           tocm: true,          			// Using [TOCM]
		           tex : true,                      // 开启科学公式 TeX 语言支持，默认关闭
		           //previewCodeHighlight : false,  // 关闭预览窗口的代码高亮，默认开启
		           flowChart : true,
		           sequenceDiagram : true,
		           //dialogLockScreen : false,      // 设置弹出层对话框不锁屏，全局通用，默认为 true
		           //dialogShowMask : false,     // 设置弹出层对话框显示透明遮罩层，全局通用，默认为 true
		           //dialogDraggable : false,    // 设置弹出层对话框不可拖动，全局通用，默认为 true
		           dialogMaskOpacity : 0.2,    // 设置透明遮罩层的透明度，全局通用，默认值为 0.1
		           dialogMaskBgColor : "#000", // 设置透明遮罩层的背景颜色，全局通用，默认为 #fff
		           imageUpload : true,
		           imageFormats : ["jpg","JPG", "jpeg","JPEG","gif","GIF","png", "PNG","bmp","BMP", "webp","WEBP",],
		           //imageUploadURL : "/DocSystem/Doc/uploadMarkdownPic.do?docId="+ docInfo.docId + "&path=" + docInfo.path + "&name=" + docInfo.name,
		           onchange : function () {
		                console.log("CommonEditor onchange");
		                commonEditor.isContentChanged = true;
			   		    console.log("textChange stackZ.size:" + commonEditor.stackZ.size() +  " stackY.size:" + commonEditor.stackY.size() +  " ctrlZY:" + commonEditor.isCtrlZY);
			   			if(false == commonEditor.isCtrlZY)
			   			{
			   				var content = this.getMarkdown();
			   				commonEditor.stackZ.push(content);
			   			}
		           },
		           onpreviewing : function () {
		               console.log("initEditorForEditormd onpreviewing switchEditModeOnly:" + commonEditor.switchEditModeOnly);
		               if(commonEditor.switchEditModeOnly)
		               {
		            	   commonEditor.switchEditModeOnly = false;
		               }
		               else
		               {
		            	   commonEditor._exitEdit(2);	//编辑器触发的退出编辑
		               }
		           },
		           onpreviewed :function () {
		               console.log("initEditorForEditormd onpreviewed switchEditModeOnly:" + commonEditor.switchEditModeOnly);
		               if(commonEditor.switchEditModeOnly)
		               {
		            	   commonEditor.switchEditModeOnly = false;
		               }
		               else
		               {
		            	   commonEditor._enableEdit(2);	//编辑器触发的退出编辑
		               }
		
		           },
		           onload : function () {
		               console.log("initEditorForEditormd onload editState:" + commonEditor.editState);
		                //TODO: 如果主动设置编辑器状态，会触发回调则需要设置
						//switchEditModeOnly = true;
		                //Disable Edit
						this.previewing(); 		  //加载成默认是预览
						this.setMarkdown(""); 	  //内容需要在onload的时候进行加载，会触发onchange事件
						commonEditor.isOnLoadTriggerChange = true;
		           },
		           onresize: function(){
		        	   console.log("initEditorForEditormd onresize");
		           }
		   		};
		   		
		  		editor = editormd("mdPlayer",params);
			};
		
			var setContent = function(content)
			{	
				editor.setMarkdown(content);
				//editor.resize();
			};

			var getContent = function()
			{	
				return editor.getMarkdown();
			};
		
			var setEditMode = function(mode)
			{
				if(mode == true)
				{	
					//显示工具条
					$("#toolBarMenu").show();
					//显示退出编辑按键
					$("#textEditorCloseBtn").show();
					//隐藏编辑按键
					$("#textEditorEditBtn").hide();
					
					//Enable Edit
					editor.previewing();
					editor.resize();
				}
				else
				{
					//隐藏工具条
					$("#toolBarMenu").hide();			
					//隐藏退出编辑按键
					$("#textEditorCloseBtn").hide();
					//显示编辑按键
					$("#textEditorEditBtn").show();		
					
					//Disable Edit
					editor.previewed();
					editor.resize();
				}
			};
			
			var onLoadDocument = function(docInfo){
				console.log("onLoadDocument() docInfo:", docInfo);
				editor.setImageUploadURL("/DocSystem/Doc/uploadMarkdownPic.do?docId="+ docInfo.docId + "&path=" + docInfo.path + "&name=" + docInfo.name);
			
				checkAndSetFileShowMode(docInfo);
				checkAndSetEditBtn(docInfo);
			};
		
			
			var config = {
				"initEditor": initEditor,
				"setContent": setContent,
				"getContent": getContent,
				"setEditMode": setEditMode,			
				"onLoadDocument": onLoadDocument,
			};
		
			function checkAndSetEditBtn(docInfo)
			{
				if(docInfo.docType == 2)
				{
					$("#textEditorEditBtn").show();
					return;
				}
				
				if(docInfo.isZip && docInfo.isZip == 1)
				{
					return;
				}
				if(docInfo.isHistory && docInfo.isHistory == 1)
				{
					return;
				}
				
				var editable = isEditableText(docInfo.fileSuffix);
				console.log("checkAndSetEditBtn() isEditableText:" + editable);
				if(editable)
				{
					$("#textEditorEditBtn").show();
				}
			}
		
			function checkAndSetFileShowMode(docInfo)
			{
				//Do nothing
			}
			
		    //Markdown的图片截图粘贴接口
		    document.addEventListener('paste', handlePasteImgEvent);
		    function handlePasteImgEvent(event)
		    {
		    	if(commonEditor.editState == undefined || commonEditor.editState == false)
		    	{
		    		return;
		    	}
		
		    	var  file = null;
		    	//粘贴事件
		        if (event.clipboardData || event.originalEvent)
		        {
		        	var clipboardData = (event.clipboardData || event.originalEvent.clipboardData);
		        	console.log("handlePasteImgEvent clipboardData", clipboardData);
		        	var items = clipboardData.items;
		            if(items)
		            {
		            	console.log("handlePasteImgEvent items", items);
		                for (var i = 0; i <items.length; i++)
		                {
		                	if (clipboardData.items[i].type.indexOf("image") !== -1)
		                	{
		                		file = items[i].getAsFile();
		                        break;
		                    }
		                }
		            }
		        }
		
		        if(file == null)
		    	{
		        	console.log("handlePasteImgEvent file is null");
		        	return;
		        }
		
		        uploadMarkdownPic(file);
		
		    	function uploadMarkdownPic(file)
		    	{
					console.log("uploadMarkdownPic() file:", file);
		
					var xhr = new XMLHttpRequest();
		
					var form = new FormData();
					form.append("editormd-image-file", file);
		
					//上传表单
					var imgName =  file.lastModified + "_" + file.name;
					var path = base64_urlsafe_encode(gDocInfo.path);
		    		var name = base64_urlsafe_encode(gDocInfo.name);
		    		var imageUploadURL = "/DocSystem/Doc/uploadMarkdownPic.do?reposId=" + gReposInfo.id + "&docId=" + gDocInfo.docId + "&path="+ path + "&name="+ name + "&imgName=" + imgName;
		      		if(gShareId)
		      		{
		      			imageUploadURL="&shareId="+gShareId;
		      		}
		    		xhr.open("post", imageUploadURL);
					xhr.send(form);
		
					//设置异步上传状态变化回调处a理函数
					xhr.onreadystatechange = function() {
						//文件上传状态
						console.log("xhr onreadystatechange() status:" + xhr.status + " readyState:" + xhr.readyState);
						if(xhr.status == 200)
						{
							if(xhr.readyState != 4)
							{
								//文件上传未结束
								return;
							}
		
							//上传成功！
							var ret = JSON.parse(xhr.responseText);
							console.log("uploadMarkdownPic ret", ret);
							if(1 == ret.success)
							{
								//上传失败
								console.log("上传成功");
						        editor.insertTextAtCursor("![]("+ ret.url +")");
							}
							else	//上传失败
							{
								//上传失败
								console.log("上传失败：" + ret.msgInfo);
								return;
				            }
						}else{
							if(xhr.status < 300)
							{
								//不是真正的异常
								return;
							}
							//上传失败
							console.log("系统异常: 上传异常！");
							return;
						}
					};
		    	}
		
		        //setImg Directly,以下代码可以直接将
		        /*
		        var render = new FileReader();
		        render.onload = function (evt) {
		            //输出base64编码
		            var base64 = evt.target.result;
		            document.getElementById('fileLogo').setAttribute('src',base64);
		        }
		        render.readAsDataURL(file);
		        return;*/
		    }
			
			//开放给外部的调用接口
			return {
				getConfig: function(){
					return config;
			    },
			}
		})();
		
		//页面加载完成处理函数
		$(document).ready(function () {
			var configForEditormd = EditormdEditor.getConfig();
			var commonEditorForEditormd = new MxsdocAPI.CommonEditor(configForEditormd);
			commonEditorForEditormd.initForVDoc();
		});
    </script>
</body>
</html>